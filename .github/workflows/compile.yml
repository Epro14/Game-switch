name: Build Switch
on: [push]
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install devkitPro (Mirror Alternativo)
        run: |
          # 1. Scarichiamo le chiavi e il database da un mirror secondario
          sudo apt-get update
          sudo apt-get install -y pacman-package-manager
          
          # 2. Usiamo un installer che punta ai mirror di riserva
          wget https://raw.githubusercontent.com/fgeyer16/devkitpro-pacman-installer/master/install-devkitpro-pacman.sh
          chmod +x install-devkitpro-pacman.sh
          sudo ./install-devkitpro-pacman.sh --noconfirm
          
          # 3. Configurazione manuale dei percorsi
          export PATH=$PATH:/opt/devkitpro/pacman/bin
          
          # 4. Installazione forzata (ignorando i blocchi 403 dove possibile)
          sudo /opt/devkitpro/pacman/bin/dkp-pacman -Syu --noconfirm
          sudo /opt/devkitpro/pacman/bin/dkp-pacman -S --needed --noconfirm switch-dev switch-sdl2

      - name: Build Game
        run: |
          export DEVKITPRO=/opt/devkitpro
          export PATH=$DEVKITPRO/devkitARM/bin:$DEVKITPRO/tools/bin:$PATH
          cd project
          make

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: StarClash-Game
          path: project/*.nro
